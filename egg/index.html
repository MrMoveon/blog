<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一.egg sns项目架构搭建 | 前端开发笔记</title>
    <meta name="description" content="前端开发笔记">
    <link rel="icon" href="/blog/icon.ico">
    
    <link rel="preload" href="/blog/assets/css/0.styles.45e5a3ae.css" as="style"><link rel="preload" href="/blog/assets/js/app.ee223f02.js" as="script"><link rel="preload" href="/blog/assets/js/2.f364336e.js" as="script"><link rel="preload" href="/blog/assets/js/5.2cc523f9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.60d9a5c4.js"><link rel="prefetch" href="/blog/assets/js/11.9d12addb.js"><link rel="prefetch" href="/blog/assets/js/12.8ef0bd8a.js"><link rel="prefetch" href="/blog/assets/js/13.71ffc42f.js"><link rel="prefetch" href="/blog/assets/js/14.25b3510a.js"><link rel="prefetch" href="/blog/assets/js/15.c4d91af5.js"><link rel="prefetch" href="/blog/assets/js/16.948c6a33.js"><link rel="prefetch" href="/blog/assets/js/17.0e6c3b39.js"><link rel="prefetch" href="/blog/assets/js/18.5f7af77b.js"><link rel="prefetch" href="/blog/assets/js/19.3d23eaff.js"><link rel="prefetch" href="/blog/assets/js/20.472050f8.js"><link rel="prefetch" href="/blog/assets/js/21.daaff1eb.js"><link rel="prefetch" href="/blog/assets/js/22.ae3ff2ee.js"><link rel="prefetch" href="/blog/assets/js/23.06d58a4e.js"><link rel="prefetch" href="/blog/assets/js/24.8df026f6.js"><link rel="prefetch" href="/blog/assets/js/25.8fa3c5ac.js"><link rel="prefetch" href="/blog/assets/js/26.b9e79cc9.js"><link rel="prefetch" href="/blog/assets/js/27.0c29d378.js"><link rel="prefetch" href="/blog/assets/js/28.5c6b388b.js"><link rel="prefetch" href="/blog/assets/js/29.a0f69e48.js"><link rel="prefetch" href="/blog/assets/js/3.641e1028.js"><link rel="prefetch" href="/blog/assets/js/30.dc7fbcb3.js"><link rel="prefetch" href="/blog/assets/js/31.a0f54c32.js"><link rel="prefetch" href="/blog/assets/js/32.06b2a848.js"><link rel="prefetch" href="/blog/assets/js/33.1707ffb1.js"><link rel="prefetch" href="/blog/assets/js/34.4a894dbb.js"><link rel="prefetch" href="/blog/assets/js/35.380e3cca.js"><link rel="prefetch" href="/blog/assets/js/36.cbda8a08.js"><link rel="prefetch" href="/blog/assets/js/37.a4ee9d32.js"><link rel="prefetch" href="/blog/assets/js/38.9d939308.js"><link rel="prefetch" href="/blog/assets/js/39.0db069f8.js"><link rel="prefetch" href="/blog/assets/js/4.dd025489.js"><link rel="prefetch" href="/blog/assets/js/40.7207834f.js"><link rel="prefetch" href="/blog/assets/js/41.a0452c50.js"><link rel="prefetch" href="/blog/assets/js/42.2122454f.js"><link rel="prefetch" href="/blog/assets/js/43.8bb0a71b.js"><link rel="prefetch" href="/blog/assets/js/44.3e769886.js"><link rel="prefetch" href="/blog/assets/js/6.86e346f0.js"><link rel="prefetch" href="/blog/assets/js/7.d17b9335.js"><link rel="prefetch" href="/blog/assets/js/8.b2177cb3.js"><link rel="prefetch" href="/blog/assets/js/9.a8aca7d1.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.45e5a3ae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">前端开发笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/framework/jquery/" class="nav-link">jquery源码分析</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/" class="nav-link">vue最佳实践</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/mobile-base-template.html" class="nav-link">vue移动端模版</a></li><li class="dropdown-item"><!----> <a href="/blog/typescript/" class="nav-link">typescript</a></li><li class="dropdown-item"><!----> <a href="/blog/mina/" class="nav-link">微信小程序</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/tools/dd-utils.html" class="nav-link">自定义工具函数库</a></li><li class="dropdown-item"><!----> <a href="/blog/vscode-plugins/" class="nav-link">vscode常用插件</a></li><li class="dropdown-item"><!----> <a href="/blog/vuepress/" class="nav-link">vuepress</a></li><li class="dropdown-item"><!----> <a href="/blog/git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/blog/mock/" class="nav-link">mock</a></li><li class="dropdown-item"><!----> <a href="/blog/tools/" class="nav-link">工具函數</a></li><li class="dropdown-item"><!----> <a href="/blog/tools/date.html" class="nav-link">日期函數</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/mongoDB/" class="nav-link">mongoDB学习</a></li><li class="dropdown-item"><!----> <a href="/blog/mongoDB/learning/aggregate.html" class="nav-link">mongoDB aggregate</a></li><li class="dropdown-item"><!----> <a href="/blog/mongoDB/learning/mongoose.html" class="nav-link">mongoose</a></li><li class="dropdown-item"><!----> <a href="/blog/Redis/" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">可视化</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/svg-canvas/svg.html" class="nav-link">svg</a></li><li class="dropdown-item"><!----> <a href="/blog/svg-canvas/canvas.html" class="nav-link">canvas</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">electron</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/electron/" class="nav-link">electron 基础</a></li><li class="dropdown-item"><!----> <a href="/blog/electron/meos.html" class="nav-link">electron 进阶</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">egg</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/egg/" class="nav-link router-link-exact-active router-link-active">egg最佳实践</a></li><li class="dropdown-item"><!----> <a href="/blog/egg/ask.html" class="nav-link">egg ask项目后端</a></li><li class="dropdown-item"><!----> <a href="/blog/egg/ask-client.html" class="nav-link">egg ask项目前端</a></li><li class="dropdown-item"><!----> <a href="/blog/egg/ask-client.html" class="nav-link">egg ask项目管理平台</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">uniapp</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/uniapp/xiaomi.html" class="nav-link">项目实战-xiaomi</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/scaffold/" class="nav-link">手撸一个前端脚手架</a></li><li class="dropdown-item"><!----> <a href="/blog/gulp_multi_pages/" class="nav-link">gulp多页面应用脚手架</a></li><li class="dropdown-item"><!----> <a href="/blog/regexp/" class="nav-link">正则学习</a></li><li class="dropdown-item"><!----> <a href="/blog/webapp/" class="nav-link">webapp</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrMoveon/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/framework/jquery/" class="nav-link">jquery源码分析</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/" class="nav-link">vue最佳实践</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/mobile-base-template.html" class="nav-link">vue移动端模版</a></li><li class="dropdown-item"><!----> <a href="/blog/typescript/" class="nav-link">typescript</a></li><li class="dropdown-item"><!----> <a href="/blog/mina/" class="nav-link">微信小程序</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/tools/dd-utils.html" class="nav-link">自定义工具函数库</a></li><li class="dropdown-item"><!----> <a href="/blog/vscode-plugins/" class="nav-link">vscode常用插件</a></li><li class="dropdown-item"><!----> <a href="/blog/vuepress/" class="nav-link">vuepress</a></li><li class="dropdown-item"><!----> <a href="/blog/git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/blog/mock/" class="nav-link">mock</a></li><li class="dropdown-item"><!----> <a href="/blog/tools/" class="nav-link">工具函數</a></li><li class="dropdown-item"><!----> <a href="/blog/tools/date.html" class="nav-link">日期函數</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/mongoDB/" class="nav-link">mongoDB学习</a></li><li class="dropdown-item"><!----> <a href="/blog/mongoDB/learning/aggregate.html" class="nav-link">mongoDB aggregate</a></li><li class="dropdown-item"><!----> <a href="/blog/mongoDB/learning/mongoose.html" class="nav-link">mongoose</a></li><li class="dropdown-item"><!----> <a href="/blog/Redis/" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">可视化</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/svg-canvas/svg.html" class="nav-link">svg</a></li><li class="dropdown-item"><!----> <a href="/blog/svg-canvas/canvas.html" class="nav-link">canvas</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">electron</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/electron/" class="nav-link">electron 基础</a></li><li class="dropdown-item"><!----> <a href="/blog/electron/meos.html" class="nav-link">electron 进阶</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">egg</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/egg/" class="nav-link router-link-exact-active router-link-active">egg最佳实践</a></li><li class="dropdown-item"><!----> <a href="/blog/egg/ask.html" class="nav-link">egg ask项目后端</a></li><li class="dropdown-item"><!----> <a href="/blog/egg/ask-client.html" class="nav-link">egg ask项目前端</a></li><li class="dropdown-item"><!----> <a href="/blog/egg/ask-client.html" class="nav-link">egg ask项目管理平台</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">uniapp</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/uniapp/xiaomi.html" class="nav-link">项目实战-xiaomi</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/scaffold/" class="nav-link">手撸一个前端脚手架</a></li><li class="dropdown-item"><!----> <a href="/blog/gulp_multi_pages/" class="nav-link">gulp多页面应用脚手架</a></li><li class="dropdown-item"><!----> <a href="/blog/regexp/" class="nav-link">正则学习</a></li><li class="dropdown-item"><!----> <a href="/blog/webapp/" class="nav-link">webapp</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/MrMoveon/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>一.egg sns项目架构搭建</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/egg/#_1-swagger-ui-文档" class="sidebar-link">1.swagger-ui 文档</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_2-自定义中间件" class="sidebar-link">2.自定义中间件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/egg/#统一错误处理" class="sidebar-link">统一错误处理</a></li></ul></li><li><a href="/blog/egg/#_3-自定义notfound页面" class="sidebar-link">3.自定义notfound页面</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_4-security安全验证" class="sidebar-link">4.security安全验证</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_4-helper" class="sidebar-link">4.helper</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_5-validate-校验" class="sidebar-link">5.validate 校验</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_6-sequelize" class="sidebar-link">6.Sequelize</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/egg/#初始化安装" class="sidebar-link">初始化安装</a></li><li class="sidebar-sub-header"><a href="/blog/egg/#编写代码" class="sidebar-link">编写代码</a></li><li class="sidebar-sub-header"><a href="/blog/egg/#踩坑-2" class="sidebar-link">踩坑</a></li><li class="sidebar-sub-header"><a href="/blog/egg/#datatypes" class="sidebar-link">Datatypes</a></li><li class="sidebar-sub-header"><a href="/blog/egg/#associations-关联" class="sidebar-link">Associations - 关联</a></li><li class="sidebar-sub-header"><a href="/blog/egg/#技巧" class="sidebar-link">技巧</a></li></ul></li><li><a href="/blog/egg/#_7-缓存" class="sidebar-link">7.缓存</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_8-路由" class="sidebar-link">8.路由</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_9-bcrypt-加密解密" class="sidebar-link">9.bcrypt 加密解密</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_1-数据表设计" class="sidebar-link">1.数据表设计</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_2-创建数据表" class="sidebar-link">2.创建数据表</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_4-路由分组" class="sidebar-link">4.路由分组</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_4-手机验证码api" class="sidebar-link">4.手机验证码api</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_5-手机登录" class="sidebar-link">5.手机登录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_6-获取用户信息" class="sidebar-link">6.获取用户信息</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_7-账号密码登录" class="sidebar-link">7.账号密码登录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_8-第三方登录" class="sidebar-link">8.第三方登录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_1-数据表设计-2" class="sidebar-link">1.数据表设计</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_2-创建数据表-2" class="sidebar-link">2.创建数据表</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_3-创建模型" class="sidebar-link">3.创建模型</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_4-创建restful-风格的url" class="sidebar-link">4.创建RESTful 风格的url</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_5-定义文档规则" class="sidebar-link">5.定义文档规则</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_6-控制器" class="sidebar-link">6.控制器</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_7-service" class="sidebar-link">7.service</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_1-数据表设计-3" class="sidebar-link">1.数据表设计</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_2-创建数据表-3" class="sidebar-link">2.创建数据表</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_3-创建模型-2" class="sidebar-link">3.创建模型</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_4-创建restful-风格的url-2" class="sidebar-link">4.创建RESTful 风格的url</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_5-定义文档规则-2" class="sidebar-link">5.定义文档规则</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_6-控制器-2" class="sidebar-link">6.控制器</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/egg/#_7-service-2" class="sidebar-link">7.service</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="一-egg-sns项目架构搭建"><a href="#一-egg-sns项目架构搭建" aria-hidden="true" class="header-anchor">#</a> 一.egg sns项目架构搭建</h1> <h2 id="_1-swagger-ui-文档"><a href="#_1-swagger-ui-文档" aria-hidden="true" class="header-anchor">#</a> 1.swagger-ui 文档</h2> <h4 id="集成"><a href="#集成" aria-hidden="true" class="header-anchor">#</a> 集成</h4> <p>egg-swagger-doc-feat是应用于eggjs的plugin,可自动生成SwaggerUI。应用启动后访问/swaagger-ui.html可以浏览页面</p> <p><strong>安装</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i egg-swagger-doc-feat --save
</code></pre></div><p><strong>示例</strong></p> <p><strong>1.创建controller/user.js</strong></p> <p>按照<a href="https://github.com/DG-Wangtao/egg-swagger-doc#controller" target="_blank" rel="noopener noreferrer">egg-swagger-doc-feat<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>文档的格式书写注释</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token comment">/**
 * @Controller 用户管理
 */</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @summary 创建用户
   * @description 创建用户 记录账户、密码、手机号
   * @router post /api/user
   * @request body createUserRequest *body 请求参数
   * @response 200 baseResponse 创建成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'create user'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserController<span class="token punctuation">;</span>

</code></pre></div><p><strong>2.创建contract/index.js</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  baseRequest<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'id 唯一键'</span><span class="token punctuation">,</span> require<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'1'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  baseResponse<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'请求成功'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    errorMessage<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>**3.创建contract/respone/user.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  createUserRequest<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'用户名'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'iuehtml'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'密码'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'123456'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    phone<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'手机号'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'13547556567'</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> <span class="token regex">/^1((3[\d])|(4[5,6,9])|(5[0-3,5-9])|(6[5-7])|(7[0-8])|(8[1-3,5-8])|(9[1,8,9]))\d{8}$/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>4.启用插件</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// {app_root}/config/plugin.js</span>
exports<span class="token punctuation">.</span>swaggerdoc <span class="token operator">=</span> <span class="token punctuation">{</span>
  enable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token keyword">package</span><span class="token punctuation">:</span> <span class="token string">'egg-swagger-doc-feat'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>5.Config配置</strong></p> <p>config.default.js</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span>swaggerdoc <span class="token operator">=</span> <span class="token punctuation">{</span>
  dirScanner<span class="token punctuation">:</span> <span class="token string">'./app/controller'</span><span class="token punctuation">,</span>
  apiInfo<span class="token punctuation">:</span> <span class="token punctuation">{</span>
   title<span class="token punctuation">:</span> <span class="token string">'sns接口文档'</span><span class="token punctuation">,</span>
   description<span class="token punctuation">:</span> <span class="token string">'sns接口文档'</span><span class="token punctuation">,</span>
   version<span class="token punctuation">:</span> <span class="token string">'1.0.0'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  schemes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'http'</span><span class="token punctuation">,</span> <span class="token string">'https'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  consumes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'application/json'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  produces<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'application/json'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  securityDefinitions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// apikey: {</span>
    <span class="token comment">//   type: 'apiKey',</span>
    <span class="token comment">//   name: 'clientkey',</span>
    <span class="token comment">//   in: 'header',</span>
    <span class="token comment">// },</span>
    <span class="token comment">// oauth2: {</span>
    <span class="token comment">//   type: 'oauth2',</span>
    <span class="token comment">//   tokenUrl: 'http://petstore.swagger.io/oauth/dialog',</span>
    <span class="token comment">//   flow: 'password',</span>
    <span class="token comment">//   scopes: {</span>
    <span class="token comment">//     'write:access_token': 'write access_token',</span>
    <span class="token comment">//     'read:access_token': 'read access_token',</span>
    <span class="token comment">//   },</span>
    <span class="token comment">// },</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  enableSecurity<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token comment">// enableValidate: true,</span>
  routerMap<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  enable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>完成插件引入之后，如果不修改默认配置，应用启动后，会自动扫描app/controller和app/contract下的文件。</p> <h4 id="踩坑"><a href="#踩坑" aria-hidden="true" class="header-anchor">#</a> 踩坑</h4> <p>在swagger-ui中，类型有 integer 、 string 、 array 、 boolean 、自定义类型，<strong>没有object类型的</strong>。</p> <p>如需要返回数据为object,可以自己创建自定义类型，例如，创建<code>contract/dto.js</code>,存放自定义类型：</p> <p>创建<code>contract/dto.js</code>,存放自定义类型：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  user<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'id 唯一键'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    user_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'uuid'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'67e9ee20-fec4-11e9-9152-116d6cc78126'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    userName<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'账户名'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'w123456'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'密码'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    mobile<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'手机号'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'15803235656'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    avatar_url<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'头像'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'https://www.baidu.com/img/baidu_jgylogo3.gif'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    status<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'状态'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    createdAt<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'2019-11-04 13:31:52'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    updatedAt<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'2019-11-04 13:31:52'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  authToken<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    token<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'token'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'eyJhbGciOiJIUzI1Ni'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  topicClass<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'id 唯一键'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    class_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'uuid'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'67e9ee20-fec4-11e9-9152-116d6cc78126'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    classname<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'账户名'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'话题01'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    status<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'状态'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    createdAt<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'2019-11-04 13:31:52'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    updatedAt<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'2019-11-04 13:31:52'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>修改<code>contract/respone/user.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>

  <span class="token comment">// 登录响应</span>
  loginResponse<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'authToken'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    msg<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'登陆成功'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 当前用户信息响应</span>
  currnetUserResponse<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'user'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    msg<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'发送成功'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>6.访问文档</strong></p> <p>运行程序</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> run dev
</code></pre></div><p>访问 http://127.0.0.1:7001/swagger-ui.html</p> <p><img src="/blog/assets/img/egg01.79b34483.png" alt="egg01"></p> <p>（egg-swagger-doc-feat详细介绍）[https://github.com/DG-Wangtao/egg-swagger-doc#controller]</p> <h2 id="_2-自定义中间件"><a href="#_2-自定义中间件" aria-hidden="true" class="header-anchor">#</a> 2.自定义中间件</h2> <h3 id="统一错误处理"><a href="#统一错误处理" aria-hidden="true" class="header-anchor">#</a> 统一错误处理</h3> <p><strong>middleware/error_handle.js</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">option<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 所有异常都在app触发一个error时间</span>
      app<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> status <span class="token operator">=</span> err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">;</span>
      <span class="token comment">// 生产环境500错误的详细内容不返回给客户端</span>
      <span class="token keyword">const</span> error <span class="token operator">=</span> status <span class="token operator">===</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>env <span class="token operator">===</span> <span class="token string">'prod'</span> <span class="token operator">?</span> <span class="token string">'Internal Server Error'</span> <span class="token punctuation">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
      <span class="token comment">//   读取所有错误信息设置到响应中</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        code<span class="token punctuation">:</span> status<span class="token punctuation">,</span>
        error<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token comment">// 用户定义型错误-&gt;请求格式正确，但是由于含有语义错误，无法响应</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">===</span> <span class="token number">422</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body<span class="token punctuation">.</span>detail <span class="token operator">=</span> err<span class="token punctuation">.</span>errors<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>启用中间件</strong></p> <p>config.default.js</p> <div class="language-js extra-class"><pre class="language-js"><code>config<span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'errorHandle'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//以下划线进行命名的中间件，需要改成驼峰是</span>
</code></pre></div><h2 id="_3-自定义notfound页面"><a href="#_3-自定义notfound页面" aria-hidden="true" class="header-anchor">#</a> 3.自定义notfound页面</h2> <p>框架支持通过配置，将默认的 HTML 请求的 404 响应重定向到指定的页面。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  notfound<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    pageUrl<span class="token punctuation">:</span> <span class="token string">'/404'</span><span class="token punctuation">,</span> <span class="token comment">//页面指向路由路径404</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>路由：</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/404'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>front<span class="token punctuation">.</span>notfound<span class="token punctuation">.</span>page404<span class="token punctuation">)</span>
</code></pre></div><p>控制器：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">NotfoundController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
 <span class="token keyword">async</span> <span class="token function">page404</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'front/404.html'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NotfoundController<span class="token punctuation">;</span>
</code></pre></div><h2 id="_4-security安全验证"><a href="#_4-security安全验证" aria-hidden="true" class="header-anchor">#</a> 4.security安全验证</h2> <ul><li>CSRF 攻击：伪造用户请求向网站发起恶意请求。</li></ul> <p>开启csrf安全验证，忽略网址为<code>/api/v1</code>和<code>ignoreList</code>的白名单。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
config<span class="token punctuation">.</span>security <span class="token operator">=</span> <span class="token punctuation">{</span>
    csrf<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      enable<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 一定要为true</span>
      <span class="token function-variable function">ignore</span><span class="token punctuation">:</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// restfull api   /api/v1 不进行安全校验</span>
        <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex">/\/api\/v1/</span><span class="token punctuation">;</span>
        <span class="token comment">// 白名单不进行校验</span>
        <span class="token keyword">const</span> ignoreList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'/login'</span><span class="token punctuation">,</span><span class="token string">'/reg'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">||</span> ignoreList<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>开启后，如果使用的nunjucks模板引擎，默认会在页面中，有表单的地方，插入csrf</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>_csrf<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>3A0YpVag-CvBuYQ_bD2716bC4cm1-WVj2yU4<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>post请求的时候，带上_csrf就可以了。</p> <h2 id="_4-helper"><a href="#_4-helper" aria-hidden="true" class="header-anchor">#</a> 4.helper</h2> <p>Helper 函数用来提供一些实用的 utility 函数。</p> <h4 id="扩展方式"><a href="#扩展方式" aria-hidden="true" class="header-anchor">#</a> 扩展方式</h4> <p>框架会把 <code>app/extend/helper.js</code> 中定义的对象与内置 <code>helper</code> 的 prototype 对象进行合并，在处理请求时会基于扩展后的 prototype 生成 <code>helper</code> 对象。</p> <p>在app/extend中创建helper.js， 增加一个 一些列辅助方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dayjs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dayjs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * @description 时间格式化
 * @param {*} time 日期
 */</span>
<span class="token keyword">function</span> <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">dayjs</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * @description 处理成功响应
 * @param {*} param0 对象 {ctx,res,msg}
 */</span>
<span class="token keyword">function</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">'请求成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> res<span class="token punctuation">,</span>
    msg<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * @description 随机生成多位验证码
 * @param {*} min 最小值
 * @param {*} max 最大值
 * @example
 * random(1000,9999) // 生成4位验证码
 */</span>
<span class="token keyword">function</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span> max</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> min<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 随机生成字母数字密码
 * @param {*} num 长度
 */</span>
<span class="token keyword">function</span> <span class="token function">randomCode</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'h'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'j'</span><span class="token punctuation">,</span> <span class="token string">'k'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'q'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'v'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    code <span class="token operator">+=</span> arr<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> code<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 校验邮箱
 * @param {*} email 
 */</span>
<span class="token keyword">function</span> <span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token parameter">email</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex">/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 校验手机号
 * @param {*} mobile 
 */</span>
<span class="token keyword">function</span> <span class="token function">isMobile</span><span class="token punctuation">(</span><span class="token parameter">mobile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex">/^1((3[\d])|(4[5,6,9])|(5[0-3,5-9])|(6[5-7])|(7[0-8])|(8[1-3,5-8])|(9[1,8,9]))\d{8}$/</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  formatTime<span class="token punctuation">,</span>
  success<span class="token punctuation">,</span>
  random<span class="token punctuation">,</span>
  randomCode<span class="token punctuation">,</span>
  isEmail<span class="token punctuation">,</span>
  isMobile<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h4 id="访问方式"><a href="#访问方式" aria-hidden="true" class="header-anchor">#</a> 访问方式</h4> <p>通过 <code>ctx.helper</code> 访问到 helper 对象，例如：</p> <p>controller/home.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello,egg,今天是：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      ctx<span class="token punctuation">,</span> res<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HomeController<span class="token punctuation">;</span>

</code></pre></div><p><img src="/blog/assets/img/egg02.3919923d.png" alt="返回数据"></p> <h2 id="_5-validate-校验"><a href="#_5-validate-校验" aria-hidden="true" class="header-anchor">#</a> 5.validate 校验</h2> <p>因为swagger-ui的contract的定义和validate-rule的定义具有极大的相似性，所以目前的版本中定义contract的同时会简单的生成相应的validate-rule.具体的使用'ctx.rule.'加Model名称直接引入。</p> <p><strong>例如：contract/user.js</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  createUserRequest<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'用户名'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'iuehtml'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'密码'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'123456'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    phone<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'手机号'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'13547556567'</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> <span class="token regex">/^1((3[\d])|(4[5,6,9])|(5[0-3,5-9])|(6[5-7])|(7[0-8])|(8[1-3,5-8])|(9[1,8,9]))\d{8}$/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>例如：controller/user.js</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token comment">/**
 * @Controller 用户管理
 */</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @summary 创建用户
   * @description 创建用户 记录账户、密码、手机号
   * @router post /api/user
   * @request body createUserRequest *body 请求参数
   * @response 200 baseResponse 创建成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>createUserRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserController<span class="token punctuation">;</span>

</code></pre></div><p><strong>安装/启用插件：</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> egg-validate --save
</code></pre></div><p><strong>config/plugin.js 启用validate</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/** @type Egg.EggPlugin */</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// had enabled by egg</span>
  <span class="token keyword">static</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    enable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  swaggerdoc<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    enable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">package</span><span class="token punctuation">:</span> <span class="token string">'egg-swagger-doc-feat'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  validate<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    enable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">package</span><span class="token punctuation">:</span> <span class="token string">'egg-validate'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre></div><p><strong>校验不通过，如下图：</strong></p> <p><img src="/blog/assets/img/egg03.480ef861.png" alt="校验不通过"></p> <p><strong>校验通过，如下图：</strong></p> <p><img src="/blog/assets/img/egg04.201b738b.png" alt="校验通过"></p> <h2 id="_6-sequelize"><a href="#_6-sequelize" aria-hidden="true" class="header-anchor">#</a> 6.Sequelize</h2> <h3 id="初始化安装"><a href="#初始化安装" aria-hidden="true" class="header-anchor">#</a> 初始化安装</h3> <p>我们会使用 sequelize 连接到 MySQL  ，并操作数据库</p> <p>安装</p> <p>安装并配置 <a href="https://github.com/eggjs/egg-sequelize" target="_blank" rel="noopener noreferrer">egg-sequelize<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 插件（它会辅助我们将定义好的 Model 对象加载到 app 和 ctx 上）和 <a href="https://github.com/sidorares/node-mysql2" target="_blank" rel="noopener noreferrer">mysql2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save egg-sequelize mysql2
</code></pre></div><p>在 <code>config/plugin.js</code> 中引入 egg-sequelize 插件</p> <div class="language- extra-class"><pre class="language-text"><code>exports.sequelize = {
  enable: true,
  package: 'egg-sequelize',
};
</code></pre></div><p>在 <code>config/config.default.js</code> 中编写 sequelize 配置</p> <div class="language-js extra-class"><pre class="language-js"><code>config<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{</span>
    dialect<span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> <span class="token string">'sns'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>通过wamp集成环境创建数据库<code>sns</code></p> <p>sequelize 提供了 <a href="https://github.com/sequelize/cli" target="_blank" rel="noopener noreferrer">sequelize-cli<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 工具来实现 <a href="http://docs.sequelizejs.com/manual/tutorial/migrations.html" target="_blank" rel="noopener noreferrer">Migrations<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，我们也可以在 egg 项目中引入 sequelize-cli</p> <p>安装 sequelize-cli</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev sequelize-cli
</code></pre></div><p>在 egg 项目中，我们希望将所有数据库 Migrations 相关的内容都放在 <code>database</code> 目录下，所以我们在项目根目录下新建一个 <code>.sequelizerc</code> 配置文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'database/config.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'migrations-path'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'database/migrations'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'seeders-path'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'database/seeders'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'models-path'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'app/model'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>初始化 Migrations 配置文件和目录</p> <div class="language-bash extra-class"><pre class="language-bash"><code>npx sequelize init:config
npx sequelize init:migrations
</code></pre></div><p>执行完后会生成 <code>database/config.json</code> 文件和 <code>database/migrations</code> 目录，我们修改一下 <code>database/config.json</code> 中的内容，将其改成我们项目中使用的数据库配置：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;development&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;database&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sns_dev&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dialect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;operatorsAliases&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;database&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sns_test&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dialect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;operatorsAliases&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;production&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;database&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sns&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dialect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;operatorsAliases&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>此时 sequelize-cli 和相关的配置也都初始化好了，我们可以开始编写项目的第一个 Migration 文件来创建我们的一个 users 表了。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>npx sequelize migration:generate --name<span class="token operator">=</span>init-users
</code></pre></div><p>执行完后会在 <code>database/migrations</code> 目录下生成一个 migration 文件(<code>${timestamp}-init-users.js</code>)，我们修改它来处理初始化 <code>users</code> 表：</p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">STRING</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Sequelize<span class="token punctuation">;</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      username<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      password<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      moblie<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      sex<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 值为1时是男性，值为2时是女性，默认值为0时是未知</span>
      avatarUrl<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 头像</span>
      created_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
      updated_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token parameter">queryInterface</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre></div><p>执行 migrate 进行数据库变更</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 升级数据库</span>
npx sequelize db:migrate
<span class="token comment"># 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更</span>
<span class="token comment"># npx sequelize db:migrate:undo</span>
<span class="token comment"># 可以通过 `db:migrate:undo:all` 回退到初始状态</span>
<span class="token comment"># npx sequelize db:migrate:undo:all</span>
</code></pre></div><p>执行之后，我们的数据库初始化就完成了。</p> <h3 id="编写代码"><a href="#编写代码" aria-hidden="true" class="header-anchor">#</a> 编写代码</h3> <p>现在终于可以开始编写代码实现业务逻辑了，首先我们来在 <code>app/model/</code> 目录下编写 user 这个 Model：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">NOW</span><span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> <span class="token constant">UUIDV1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 主键自增</span>
    user_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token constant">UUIDV1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 设置uuid模式 433a4990-f6f3-11e9-a104-21c1dd7632ad</span>
    username<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    moblie<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    sex<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 值为1时是男性，值为2时是女性，默认值为0时是未知</span>
    avatar_url<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 头像</span>
    status<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 值为1时启用，值为0时禁用</span>
    created_at<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token constant">NOW</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 创建时间</span>
    updated_at<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token constant">NOW</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 更新时间</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>这个 Model 就可以在 Controller 和 Service 中通过 <code>app.model.User</code> 或者 <code>ctx.model.User</code> 访问到了，例如我们修改 <code>app/controller/users.js</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token comment">/**
 * @Controller 用户管理
 */</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @summary 创建用户
   * @description 创建用户 记录账户、密码、手机号
   * @router post /api/user
   * @request body createUserRequest *body 请求参数
   * @response 200 baseResponse 创建成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>createUserRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">'用户创建失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'用户创建成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserController<span class="token punctuation">;</span>

</code></pre></div><h3 id="踩坑-2"><a href="#踩坑-2" aria-hidden="true" class="header-anchor">#</a> 踩坑</h3> <h4 id="时间问题"><a href="#时间问题" aria-hidden="true" class="header-anchor">#</a> 时间问题</h4> <p>mysql保存时会自动保存为UTC格式，可以在config中配置</p> <div class="language-js extra-class"><pre class="language-js"><code>config<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{</span>
    dialect<span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> <span class="token string">'sns'</span><span class="token punctuation">,</span>
    timezone<span class="token punctuation">:</span> <span class="token string">'+08:00'</span><span class="token punctuation">,</span> <span class="token comment">// 保存为本地时区</span>
    dialectOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      dateStrings<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function">typeCast</span><span class="token punctuation">(</span><span class="token parameter">field<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// for reading from database</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'DATETIME'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> field<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="数据库表名问题"><a href="#数据库表名问题" aria-hidden="true" class="header-anchor">#</a> 数据库表名问题</h4> <p>默认情况下，sequelize将自动将所有传递的模型名称（define的第一个参数）转换为复数，
但是为了安全着想，复数的转换可能会发生变化，所以需要禁止该行为：</p> <p>在model中设置 <code>freezeTableName: true,</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// model/user_info.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">NOW</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> UserInfo <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'userInfo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    user_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    username<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    sex<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 值为1时是男性，值为2时是女性，默认值为0时是未知</span>
    age<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 年龄</span>
    qg<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 情感</span>
    job<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 工作</span>
    birthday<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 生日</span>
    address<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 家乡</span>
    created_at<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token constant">NOW</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 创建时间</span>
    updated_at<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token constant">NOW</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 更新时间</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自动生成时间  </span>
    timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 禁止修改表名，默认情况下，sequelize将自动将所有传递的模型名称（define的第一个参数）转换为复数</span>
    <span class="token comment">// 但是为了安全着想，复数的转换可能会发生变化，所以禁止该行为</span>
    freezeTableName<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 数据库表名字</span>
    tableName<span class="token punctuation">:</span> <span class="token string">'user_info'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> UserInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h4 id="中文乱码问题"><a href="#中文乱码问题" aria-hidden="true" class="header-anchor">#</a> 中文乱码问题</h4> <p>如果中文插入乱码，可以修改config/config.default.js,增加<code>define:{}</code>这串代码</p> <div class="language-js extra-class"><pre class="language-js"><code> config<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{</span>
    dialect<span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> <span class="token string">'sns'</span><span class="token punctuation">,</span>
    <span class="token comment">// 解决中文输入问题</span>
    define<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      underscored<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      charset<span class="token punctuation">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span>
      dialectOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        collate<span class="token punctuation">:</span> <span class="token string">'utf8_general_ci'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    timezone<span class="token punctuation">:</span> <span class="token string">'+08:00'</span><span class="token punctuation">,</span> <span class="token comment">// 保存为本地时区</span>
    dialectOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      dateStrings<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function">typeCast</span><span class="token punctuation">(</span><span class="token parameter">field<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// for reading from database</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'DATETIME'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> field<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>如果修改配置项不能解决，可以查看 <code>MySQL</code> 默认字符集 ，如果不是utf8,修改为utf8。</p> <p><strong>操作方式01 ：</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>
mysql -u root -p
<span class="token comment">## 输入密码</span>

<span class="token comment">## 查看各种默认配置</span>
show variables like <span class="token string">'%char%'</span><span class="token punctuation">;</span>

<span class="token comment">## 会有一个表 大概如下</span>
<span class="token comment">## 部分utf8 可能会是其他值，然后我们慢慢修改</span>
<span class="token comment">## set character_set_client=utf8</span>
<span class="token comment">## 也可以用以上方法设置，但重启 mysql 又会回到原点</span>
+--------------------------+----------------------------+
<span class="token operator">|</span> Variable_name            <span class="token operator">|</span> Value                      <span class="token operator">|</span>
+--------------------------+----------------------------+
<span class="token operator">|</span> character_set_client     <span class="token operator">|</span> utf8                       <span class="token operator">|</span>
<span class="token operator">|</span> character_set_connection <span class="token operator">|</span> utf8                       <span class="token operator">|</span>
<span class="token operator">|</span> character_set_database   <span class="token operator">|</span> utf8                       <span class="token operator">|</span>
<span class="token operator">|</span> character_set_filesystem <span class="token operator">|</span> binary                     <span class="token operator">|</span>
<span class="token operator">|</span> character_set_results    <span class="token operator">|</span> utf8                       <span class="token operator">|</span>
<span class="token operator">|</span> character_set_server     <span class="token operator">|</span> utf8                       <span class="token operator">|</span>
<span class="token operator">|</span> character_set_system     <span class="token operator">|</span> utf8                       <span class="token operator">|</span>
<span class="token operator">|</span> character_sets_dir       <span class="token operator">|</span> /usr/share/mysql/charsets/ <span class="token operator">|</span>
+--------------------------+----------------------------+
</code></pre></div><p><strong>操作方式02 ：</strong></p> <p>打开wamp集成环境的phpmyadmin -&gt;打开变量面板-&gt;将以上变量修改为utf8.</p> <h3 id="datatypes"><a href="#datatypes" aria-hidden="true" class="header-anchor">#</a> Datatypes</h3> <div class="language-js extra-class"><pre class="language-js"><code>Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span>                      <span class="token comment">// VARCHAR(255)</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">1234</span><span class="token punctuation">)</span>                <span class="token comment">// VARCHAR(1234)</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">.</span><span class="token constant">BINARY</span>               <span class="token comment">// VARCHAR BINARY</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">TEXT</span>                        <span class="token comment">// TEXT</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">(</span><span class="token string">'tiny'</span><span class="token punctuation">)</span>                <span class="token comment">// TINYTEXT</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">CITEXT</span>                      <span class="token comment">// CITEXT      PostgreSQL and SQLite only.</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span>                     <span class="token comment">// INTEGER</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">BIGINT</span>                      <span class="token comment">// BIGINT</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>                  <span class="token comment">// BIGINT(11)</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">FLOAT</span>                       <span class="token comment">// FLOAT</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>                   <span class="token comment">// FLOAT(11)</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>               <span class="token comment">// FLOAT(11,10)</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">REAL</span>                        <span class="token comment">// REAL        PostgreSQL only.</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">REAL</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>                    <span class="token comment">// REAL(11)    PostgreSQL only.</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">REAL</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span>                <span class="token comment">// REAL(11,12) PostgreSQL only.</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">DOUBLE</span>                      <span class="token comment">// DOUBLE</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">DOUBLE</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>                  <span class="token comment">// DOUBLE(11)</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">DOUBLE</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>              <span class="token comment">// DOUBLE(11,10)</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">DECIMAL</span>                     <span class="token comment">// DECIMAL</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>              <span class="token comment">// DECIMAL(10,2)</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span>                        <span class="token comment">// DATETIME for mysql / sqlite, TIMESTAMP WITH TIME ZONE for postgres</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>                     <span class="token comment">// DATETIME(6) for mysql 5.6.4+. Fractional seconds support with up to 6 digits of precision</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">DATEONLY</span>                    <span class="token comment">// DATE without time.</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">BOOLEAN</span>                     <span class="token comment">// TINYINT(1)</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">ENUM</span><span class="token punctuation">(</span><span class="token string">'value 1'</span><span class="token punctuation">,</span> <span class="token string">'value 2'</span><span class="token punctuation">)</span>  <span class="token comment">// An ENUM with allowed values 'value 1' and 'value 2'</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">ARRAY</span><span class="token punctuation">(</span>Sequelize<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">)</span>       <span class="token comment">// Defines an array. PostgreSQL only.</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">ARRAY</span><span class="token punctuation">(</span>Sequelize<span class="token punctuation">.</span><span class="token constant">ENUM</span><span class="token punctuation">)</span>       <span class="token comment">// Defines an array of ENUM. PostgreSQL only.</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">JSON</span>                        <span class="token comment">// JSON column. PostgreSQL, SQLite and MySQL only.</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">JSONB</span>                       <span class="token comment">// JSONB column. PostgreSQL only.</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">BLOB</span>                        <span class="token comment">// BLOB (bytea for PostgreSQL)</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">BLOB</span><span class="token punctuation">(</span><span class="token string">'tiny'</span><span class="token punctuation">)</span>                <span class="token comment">// TINYBLOB (bytea for PostgreSQL. Other options are medium and long)</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">UUID</span>                        <span class="token comment">// UUID datatype for PostgreSQL and SQLite, CHAR(36) BINARY for MySQL (use defaultValue: Sequelize.UUIDV1 or Sequelize.UUIDV4 to make sequelize generate the ids automatically)</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">CIDR</span>                        <span class="token comment">// CIDR datatype for PostgreSQL</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">INET</span>                        <span class="token comment">// INET datatype for PostgreSQL</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">MACADDR</span>                     <span class="token comment">// MACADDR datatype for PostgreSQL</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">RANGE</span><span class="token punctuation">(</span>Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">)</span>    <span class="token comment">// Defines int4range range. PostgreSQL only.</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">RANGE</span><span class="token punctuation">(</span>Sequelize<span class="token punctuation">.</span><span class="token constant">BIGINT</span><span class="token punctuation">)</span>     <span class="token comment">// Defined int8range range. PostgreSQL only.</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">RANGE</span><span class="token punctuation">(</span>Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">)</span>       <span class="token comment">// Defines tstzrange range. PostgreSQL only.</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">RANGE</span><span class="token punctuation">(</span>Sequelize<span class="token punctuation">.</span><span class="token constant">DATEONLY</span><span class="token punctuation">)</span>   <span class="token comment">// Defines daterange range. PostgreSQL only.</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">RANGE</span><span class="token punctuation">(</span>Sequelize<span class="token punctuation">.</span><span class="token constant">DECIMAL</span><span class="token punctuation">)</span>    <span class="token comment">// Defines numrange range. PostgreSQL only.</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">ARRAY</span><span class="token punctuation">(</span>Sequelize<span class="token punctuation">.</span><span class="token constant">RANGE</span><span class="token punctuation">(</span>Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Defines array of tstzrange ranges. PostgreSQL only.</span>

Sequelize<span class="token punctuation">.</span><span class="token constant">GEOMETRY</span>                    <span class="token comment">// Spatial column.  PostgreSQL (with PostGIS) or MySQL only.</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">GEOMETRY</span><span class="token punctuation">(</span><span class="token string">'POINT'</span><span class="token punctuation">)</span>           <span class="token comment">// Spatial column with geometry type. PostgreSQL (with PostGIS) or MySQL only.</span>
Sequelize<span class="token punctuation">.</span><span class="token constant">GEOMETRY</span><span class="token punctuation">(</span><span class="token string">'POINT'</span><span class="token punctuation">,</span> <span class="token number">4326</span><span class="token punctuation">)</span>     <span class="token comment">// Spatial column with geometry type and SRID.  PostgreSQL (with PostGIS) or MySQL only.</span>
</code></pre></div><h3 id="associations-关联"><a href="#associations-关联" aria-hidden="true" class="header-anchor">#</a> Associations - 关联</h3> <h3 id="技巧"><a href="#技巧" aria-hidden="true" class="header-anchor">#</a> 技巧</h3> <h4 id="_1-显示隐藏字段"><a href="#_1-显示隐藏字段" aria-hidden="true" class="header-anchor">#</a> 1.显示隐藏字段</h4> <ul><li>exclude 排除不需要的字段</li> <li>include 显示需要的字段</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">[</span>ctx<span class="token punctuation">.</span>currentModel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span> exclude<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'createdAt'</span><span class="token punctuation">,</span> <span class="token string">'updatedAt'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_2-关联查询，去掉关联中间表字段"><a href="#_2-关联查询，去掉关联中间表字段" aria-hidden="true" class="header-anchor">#</a> 2.关联查询，去掉关联中间表字段</h4> <p>如以下结果，需要去掉中间表内容picture_topic， 用attributes.exclude是没效果的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;pictures&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;/public/static/logo.png&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;picture_topic&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">&quot;picture_id&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;topic_id&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;/public/static/logo.png&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;picture_topic&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">&quot;picture_id&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;topic_id&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>

</code></pre></div><p>我们需要在关联查询，through 中，attributes设置为空数组，即可达到效果</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">[</span>ctx<span class="token punctuation">.</span>currentModel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span> exclude<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'createdAt'</span><span class="token punctuation">,</span> <span class="token string">'updatedAt'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      include<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> model<span class="token punctuation">:</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Picture<span class="token punctuation">,</span> through<span class="token punctuation">:</span> <span class="token punctuation">{</span> attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'url'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>查询显示为：</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token string">&quot;pictures&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;/public/static/logo.png&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;/public/static/logo.png&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
</code></pre></div><h2 id="_7-缓存"><a href="#_7-缓存" aria-hidden="true" class="header-anchor">#</a> 7.缓存</h2> <p><a href="https://github.com/hexindai/egg-cache/blob/master/README.zh_CN.md" target="_blank" rel="noopener noreferrer">egg-cache<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>通过简单的配置就可以直接使用基于 <a href="https://github.com/BryanDonovan/node-cache-manager" target="_blank" rel="noopener noreferrer">cache-manager<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 开发的 store ，</p> <p>运用场景：可以用于短信验证码的存储</p> <p><strong>安装</strong>：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i egg-cache --save
</code></pre></div><p><strong>配置</strong>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/plugin.js</span>
exports<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token punctuation">{</span>
  enable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token keyword">package</span><span class="token punctuation">:</span> <span class="token string">'egg-cache'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
exports<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">'memory'</span><span class="token punctuation">,</span>
  stores<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    memory<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      driver<span class="token punctuation">:</span> <span class="token string">'memory'</span><span class="token punctuation">,</span>
      max<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      ttl<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>使用：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'bar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'bar'</span>

<span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 'default'</span>

<span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>

<span class="token comment">// 使用闭包</span>
<span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'bar'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'bar'</span>

<span class="token comment">// 异步结果</span>
<span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 'bar'</span>

<span class="token comment">// 获取缓存，如果不存在则使用闭包中的结果生成，这在很多日常需求中十分有效</span>
<span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'bar'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'bar'</span>

<span class="token comment">// 和 set 一样，你也可以指定有效期和一些选项</span>
<span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'bar'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  foo<span class="token punctuation">:</span> <span class="token string">'bar'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  foo 已被缓存</span>
<span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'bar'</span>
</code></pre></div><h2 id="_8-路由"><a href="#_8-路由" aria-hidden="true" class="header-anchor">#</a> 8.路由</h2> <p>sns项目路由采用插件 <strong><a href="https://github.com/zzzs/egg-router-group" target="_blank" rel="noopener noreferrer">egg-router-group<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong>， 使eggjs具有路由群组操作的能力</p> <p><strong>安装：</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i egg-router-group --save
</code></pre></div><p><strong>配置：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span>routerGroup <span class="token operator">=</span> <span class="token punctuation">{</span>
  enable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token keyword">package</span><span class="token punctuation">:</span> <span class="token string">'egg-router-group'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>路由群组允许你共用路由属性，例如：路由别名前缀，路由url前缀，中间件等，你可以利用路由群组统一为多个路由设置共同属性，而不需在每个路由上都设置一次。共用属性被指定为对象格式，当作 app.router.group 方法的第一个参数，具体路由群组的相关内容，可参考下面几个常用样例来熟悉这些特性。</p> <p><strong>目前支持这三种属性</strong></p> <ul><li>路由别名前缀: name</li> <li>路由url前缀: prefix</li> <li>中间件: middlewares</li></ul> <p><strong>基本用法</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// {app_root}/app/router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller<span class="token punctuation">,</span> middleware <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  <span class="token keyword">const</span> m1 <span class="token operator">=</span> middleware<span class="token punctuation">.</span><span class="token function">m1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> m2 <span class="token operator">=</span> middleware<span class="token punctuation">.</span><span class="token function">m2</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token punctuation">:</span> <span class="token string">'value'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> m3 <span class="token operator">=</span> middleware<span class="token punctuation">.</span><span class="token function">m3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'home::'</span><span class="token punctuation">,</span> prefix<span class="token punctuation">:</span> <span class="token string">'/pre'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span> m1<span class="token punctuation">,</span> m2 <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// router-path: /pre/test, middlewares: m1, m2</span>
    <span class="token comment">// router-path: /pre/test2, middlewares: m1, m2</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>test<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test2'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// router-name: home::post, router-path: /pre/post, middlewares: m1, m2, m3</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'/post'</span><span class="token punctuation">,</span> m3<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// others</span>
    router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>all1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'testname'</span><span class="token punctuation">,</span> <span class="token string">'/test2'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>all2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/put'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>put<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'/delete'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>delete<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">'/del'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>del<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token string">'/options'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token string">'/patch'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>patch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/redirect'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/redirect2'</span><span class="token punctuation">,</span> <span class="token string">'home::testname'</span><span class="token punctuation">,</span> <span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置单个属性</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'home::'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// router-path: /test</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// router-name: home::post, router-path: /post</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'/post'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// group 同样支持链式操作</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'home::'</span><span class="token punctuation">,</span> prefix<span class="token punctuation">:</span> <span class="token string">'/pre'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span> m1<span class="token punctuation">,</span> m2 <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// router-path: /pre/test, middlewares: m1, m2</span>
    <span class="token comment">// router-path: /pre/test2, middlewares: m1, m2 ⚠️这里🈶️group 设置的属性哦</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>test<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test2'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test3'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// router-path: /test3 ⚠️这里🈚group 设置的属性哦</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="_9-bcrypt-加密解密"><a href="#_9-bcrypt-加密解密" aria-hidden="true" class="header-anchor">#</a> 9.bcrypt 加密解密</h2> <p>egg-bcrypt 是基于bcrypt的加密库</p> <p>安装：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i egg-bcrypt --save
</code></pre></div><p>config.default.js 设置参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// bcrypt 参数</span>
config<span class="token punctuation">.</span>bcrypt <span class="token operator">=</span> <span class="token punctuation">{</span>
    saltRounds<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 加盐长度 default 10</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>config/plugin.js 启用插件</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span>bcrypt <span class="token operator">=</span> <span class="token punctuation">{</span>
  enable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token keyword">package</span><span class="token punctuation">:</span> <span class="token string">'egg-bcrypt'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当用户进行注册的时候，我们需要加密密码，</p> <p>当用户登录时候，我们需要校验密码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//密码加密</span>
<span class="token keyword">const</span> password <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">randomCode</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> passwordHash <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">genHash</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//校验密码</span>
<span class="token keyword">const</span> compareResult <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="二-登陆模块开发"><a href="#二-登陆模块开发" aria-hidden="true" class="header-anchor">#</a> 二.登陆模块开发</h1> <h2 id="_1-数据表设计"><a href="#_1-数据表设计" aria-hidden="true" class="header-anchor">#</a> 1.数据表设计</h2> <p><strong>user 表</strong></p> <table><thead><tr><th><strong>字段</strong></th> <th><strong>类型</strong></th> <th><strong>Null</strong></th> <th><strong>默认</strong></th> <th><strong>额外</strong></th> <th>描述</th></tr></thead> <tbody><tr><td>id</td> <td>int(11)</td> <td>否</td> <td></td> <td>auto_increment</td> <td></td></tr> <tr><td>user_id</td> <td>char(36)</td> <td>否</td> <td></td> <td></td> <td>uuid</td></tr> <tr><td>username</td> <td>varchar(30)</td> <td>否</td> <td></td> <td></td> <td>账户</td></tr> <tr><td>password</td> <td>varchar(255)</td> <td>否</td> <td></td> <td></td> <td>密码</td></tr> <tr><td>mobile</td> <td>varchar(11)</td> <td>否</td> <td></td> <td></td> <td>手机号</td></tr> <tr><td>avatar_url</td> <td>varchar(255)</td> <td>是</td> <td><em>NULL</em></td> <td></td> <td>头像</td></tr> <tr><td>status</td> <td>tinyint(1)</td> <td>否</td> <td></td> <td></td> <td>状态</td></tr> <tr><td>created_at</td> <td>datetime</td> <td>否</td> <td></td> <td></td> <td>创建时间</td></tr> <tr><td>updated_at</td> <td>datetime</td> <td>否</td> <td></td> <td></td> <td>更新时间</td></tr> <tr><td>login_ip</td> <td>varchar(15)</td> <td>是</td> <td><em>NULL</em></td> <td></td> <td>登录ip</td></tr></tbody></table> <p><strong>user_info 表</strong></p> <table><thead><tr><th><strong>字段</strong></th> <th><strong>类型</strong></th> <th><strong>Null</strong></th> <th><strong>默认</strong></th> <th><strong>额外</strong></th> <th>描述</th></tr></thead> <tbody><tr><td>id</td> <td>int(11)</td> <td>否</td> <td></td> <td>auto_increment</td> <td></td></tr> <tr><td>user_id</td> <td>char(36)</td> <td>否</td> <td></td> <td></td> <td>关联user id</td></tr> <tr><td>sex</td> <td>tinyint(1)</td> <td>否</td> <td>0</td> <td></td> <td>性别</td></tr> <tr><td>age</td> <td>varchar(30)</td> <td>是</td> <td></td> <td></td> <td>年龄</td></tr> <tr><td>qg</td> <td></td> <td>是</td> <td></td> <td></td> <td>情感</td></tr> <tr><td>job</td> <td></td> <td>是</td> <td></td> <td></td> <td>工作</td></tr> <tr><td>birthday</td> <td></td> <td>是</td> <td></td> <td></td> <td>生日</td></tr> <tr><td>address</td> <td></td> <td>是</td> <td></td> <td></td> <td>家乡</td></tr> <tr><td>created_at</td> <td>datetime</td> <td>否</td> <td></td> <td></td> <td>创建时间</td></tr> <tr><td>updated_at</td> <td>datetime</td> <td>否</td> <td></td> <td></td> <td>更新时间</td></tr></tbody></table> <p>user_bind 表</p> <table><thead><tr><th><strong>字段</strong></th> <th><strong>类型</strong></th> <th><strong>Null</strong></th> <th><strong>默认</strong></th> <th><strong>额外</strong></th> <th>描述</th></tr></thead> <tbody><tr><td>id</td> <td>int(11)</td> <td>否</td> <td></td> <td>auto_increment</td> <td></td></tr> <tr><td>user_id</td> <td>char(36)</td> <td>否</td> <td></td> <td></td> <td>关联user id</td></tr> <tr><td>type</td> <td>varchar(255)</td> <td>否</td> <td></td> <td></td> <td></td></tr> <tr><td>openid</td> <td>varchar(255)</td> <td>否</td> <td></td> <td></td> <td></td></tr> <tr><td>nickname</td> <td>varchar(255)</td> <td>否</td> <td></td> <td></td> <td></td></tr> <tr><td>avatarurl</td> <td>varchar(255)</td> <td>是</td> <td><em>NULL</em></td> <td></td> <td>头像</td></tr> <tr><td>created_at</td> <td>datetime</td> <td>否</td> <td></td> <td></td> <td>创建时间</td></tr> <tr><td>updated_at</td> <td>datetime</td> <td>否</td> <td></td> <td></td> <td>更新时间</td></tr></tbody></table> <h2 id="_2-创建数据表"><a href="#_2-创建数据表" aria-hidden="true" class="header-anchor">#</a> 2.创建数据表</h2> <p>执行sequelize命令创建<code>user</code>、<code>user_info</code>、<code>user_bind</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>npx sequelize migration:generate --name<span class="token operator">=</span>init-user
npx sequelize migration:generate --name<span class="token operator">=</span>init-user_info
npx sequelize migration:generate --name<span class="token operator">=</span>init-user_bind
</code></pre></div><p>生成以下文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 20191028094909-init-user.js</span>
<span class="token comment"># 20191028094909-init-user_info.js</span>
<span class="token comment"># 20191028094909-init-user_bind.js</span>
</code></pre></div><p>初始化表：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// database/migrations/20191028094909-init-user.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> <span class="token constant">UUIDV1</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Sequelize<span class="token punctuation">;</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 主键</span>
      user_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token constant">UUIDV1</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// uuid</span>
      username<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 用户名</span>
      password<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 密码</span>
      mobile<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 手机</span>
      email<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 邮箱</span>
      avatar_url<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 头像</span>
      status<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 值为1时启用，值为0时禁用</span>
      login_ip<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 最后登录ip</span>
      created_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
      updated_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      engine<span class="token punctuation">:</span> <span class="token string">'InnoDB'</span><span class="token punctuation">,</span><span class="token comment">// 表引擎</span>
      comment<span class="token punctuation">:</span> <span class="token string">'用户表'</span><span class="token punctuation">,</span><span class="token comment">// 备注</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      queryInterface<span class="token punctuation">.</span><span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'mobile'</span><span class="token punctuation">,</span> <span class="token string">'email'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 普通索引</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token parameter">queryInterface</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// database/migrations/20191028094909-init-user_info.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Sequelize<span class="token punctuation">;</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'user_info'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 主键id</span>
      user_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// uuid</span>
      nickname<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      sex<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 1-男性，2-女性，0-未知</span>
      age<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 年龄</span>
      qg<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 情感</span>
      job<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 工作</span>
      birthday<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 生日</span>
      address<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 家乡</span>
      created_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
      updated_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      engine<span class="token punctuation">:</span> <span class="token string">'InnoDB'</span><span class="token punctuation">,</span>
      comment<span class="token punctuation">:</span> <span class="token string">'用户信息表'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      queryInterface<span class="token punctuation">.</span><span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token string">'user_info'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'nickname'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token parameter">queryInterface</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'user_info'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// database/migrations/20191028094909-init-user_bind.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">UUID</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Sequelize<span class="token punctuation">;</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'user_bind'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      user_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 用户id</span>
      type<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 第三方昵称</span>
      openid<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// openid</span>
      nickname<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 昵称</span>
      avatarurl<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 头像</span>
      created_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
      updated_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token parameter">queryInterface</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'user_bind'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>执行 migrate 进行数据库变更</p> <div class="language-bash extra-class"><pre class="language-bash"><code>npx sequelize db:migrate
</code></pre></div><p><img src="/blog/assets/img/egg05.52c21775.png" alt="生成数据表"></p> <h2 id="_4-路由分组"><a href="#_4-路由分组" aria-hidden="true" class="header-anchor">#</a> 4.路由分组</h2> <p>由于采用了jwt权限校验，路由我们需要进行权限分组，例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// {app_root}/app/router.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 不需要验证token</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">:</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/phoneLogin'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>phoneLogin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/sendSms'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>sendSms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 需要验证token</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">:</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span> app<span class="token punctuation">.</span>jwt <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/logout'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>jwt<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>logout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/current'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>jwt<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>user控制器创建对应的方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token comment">/**
 * @Controller 用户管理
 */</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  
  <span class="token keyword">async</span> <span class="token function">phoneLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   
  <span class="token punctuation">}</span>
 
  <span class="token keyword">async</span> <span class="token function">sendSms</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   
  <span class="token punctuation">}</span>
  
  <span class="token keyword">async</span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserController<span class="token punctuation">;</span>

</code></pre></div><h4 id="拆分路由"><a href="#拆分路由" aria-hidden="true" class="header-anchor">#</a> 拆分路由</h4> <p>当应用体积庞大，几十上百个路由全放到<code>/app/router.js</code>中，会引起路由文件臃肿，查找修改困难。</p> <p>这里我们可以进行路由拆分，不同的场景拆分不同的js文件。</p> <p>例如，在项目中我们会有后台模块，前台模块，api模块。</p> <p>我们在/app/中创建router文件夹，并创建模块</p> <div class="language-bash extra-class"><pre class="language-bash"><code>├─router
│      admin.js
│      api.js
│      front.js
</code></pre></div><p>api.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * api v1 路由
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
 
  <span class="token comment">// 不需要验证token</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">:</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>


    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/phoneLogin'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>phoneLogin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/login'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/sendSms'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>sendSms<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'/class'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'/topicclass'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>topicClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'/topic'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 需要验证token</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">:</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span> app<span class="token punctuation">.</span>jwt <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// user</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/logout'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>jwt<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>logout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/current'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>jwt<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/followTopic'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>followTopic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// upload</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload/single'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>single<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload/multi'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>multi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// userinfo</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/userinfo/show/:userid'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>userinfo<span class="token punctuation">.</span>show<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/userinfo/update/:userid'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>userinfo<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>front.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 前台路由
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  <span class="token comment">// front</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/topic'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>front<span class="token punctuation">.</span>index<span class="token punctuation">.</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/reg'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>front<span class="token punctuation">.</span>index<span class="token punctuation">.</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>front<span class="token punctuation">.</span>index<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>front<span class="token punctuation">.</span>index<span class="token punctuation">.</span>dologin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>front<span class="token punctuation">.</span>index<span class="token punctuation">.</span>logout<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>在app/router.js引入模块</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// v1</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/api.js'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
  <span class="token comment">// front</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/front.js'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
  <span class="token comment">//  admin</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/admin.js'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>这样进行拆分，就可以有效进行查找了。</p> <h2 id="_4-手机验证码api"><a href="#_4-手机验证码api" aria-hidden="true" class="header-anchor">#</a> 4.手机验证码api</h2> <h4 id="手机验证码流程"><a href="#手机验证码流程" aria-hidden="true" class="header-anchor">#</a> 手机验证码流程</h4> <p>（1）接收手机号码</p> <p>（2）验证手机号码合法性</p> <p>（3）判断是否已经获取过验证码（判断缓存中是否存在当前手机号的验证码，有则提示“你已经获取过验证码了”）</p> <p>（4）生成4位数随机数字</p> <p>（5）发送短信（腾讯云）</p> <p>（6）手机号=&gt;验证码 的形式保存在缓存中（60秒）</p> <p>（7）提示成功</p> <p>**路由层：****/app/router.js</p> <p>路由增加sendSms</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// {app_root}/app/router.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  <span class="token comment">// 不需要验证token</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">:</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/sendSms'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>sendSms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>**contract层：**contract/user.js</p> <p>增加<code>sendSmsRequest</code>请求校验和<code>sendSmsResponse</code>成功响应</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 发送短信请求</span>
  sendSmsRequest<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    mobile<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'手机号'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'13547556567'</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> <span class="token regex">/^1((3[\d])|(4[5,6,9])|(5[0-3,5-9])|(6[5-7])|(7[0-8])|(8[1-3,5-8])|(9[1,8,9]))\d{8}$/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 发送短信响应</span>
  sendSmsResponse<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    msg<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'发送成功'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
      
</code></pre></div><p>**controller层：**controller/v1/user.js</p> <p>增加发送验证码的方法<code>sendSms()</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
   * @summary 发送验证码
   * @description 发送验证码
   * @router post /api/v1/user/sendSms
   * @request body sendSmsRequest *body 请求参数
   * @response 200 sendSmsResponse 发送成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">sendSms</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.校验参数</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>sendSmsRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.发送验证码</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">sendSms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送成功，返回消息  </span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'发送成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>**service层：**service/user.js</p> <p>中增加发送验证码的方法<code>sendSms()</code>，发送验证码业务逻辑主要在service中编写</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 发送短信验证码</span>
  <span class="token keyword">async</span> <span class="token function">sendSms</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> config<span class="token punctuation">,</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> mobile <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>mobile<span class="token punctuation">;</span>
    <span class="token comment">// 1.缓存中是否已有发送的验证码</span>
    <span class="token keyword">const</span> isSend <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isSend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'您操作得太快了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2.生成4位验证码</span>
    <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3.发送验证码</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>qcloudsms<span class="token punctuation">.</span><span class="token function">sendSingleSms</span><span class="token punctuation">(</span>mobile<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.如果返回有状态码，发送失败，抛出错误 { result: 1038, errmsg: '验证码模板参数格式错误', ext: ''}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 4.1 发送成功，服务端缓存验证码</span>
      <span class="token keyword">await</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mobile<span class="token punctuation">,</span> code<span class="token punctuation">,</span> config<span class="token punctuation">.</span>qcloudsms<span class="token punctuation">.</span>expire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 4.2 抛出错误</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>errmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>**config层：**定义腾讯云短信配置文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//config/config.default.js</span>

config<span class="token punctuation">.</span>qcloudsms <span class="token operator">=</span> <span class="token punctuation">{</span>
    isOpen<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否开启腾讯sms,未去实现此功能</span>
    expire<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 发送验证码间隔时间</span>
    appid<span class="token punctuation">:</span> <span class="token string">'1400276838'</span><span class="token punctuation">,</span> <span class="token comment">// // 短信应用 SDK AppID</span>
    appkey<span class="token punctuation">:</span> <span class="token string">'d503d2518cbc9e8es77373fdac05a1dad'</span><span class="token punctuation">,</span> <span class="token comment">// 短信应用 SDK AppKey</span>
    smsSign<span class="token punctuation">:</span> <span class="token string">'iuehtml'</span><span class="token punctuation">,</span> <span class="token comment">// 签名内容</span>
    templateId<span class="token punctuation">:</span> <span class="token string">'455353'</span><span class="token punctuation">,</span> <span class="token comment">// 短信模板ID，需要在短信应用中申请</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>签名等配置参数请登录腾讯云购买短信业务</p> <p>默认会赠送100条进行测试</p></blockquote> <h4 id="腾讯短信api对接"><a href="#腾讯短信api对接" aria-hidden="true" class="header-anchor">#</a> 腾讯短信api对接</h4> <p><a href="https://www.npmjs.com/package/qcloudsms_js" target="_blank" rel="noopener noreferrer">腾讯云短信 Node.js SDK文档地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>安装：</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> qcloudsms_js
</code></pre></div><p>创建<code>service/qcloudsms.js</code>,对短信业务进行封装</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> QcloudSms <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'qcloudsms_js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">QcloudsmsService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
     * 发送单条短信
     * @param {*} mobile 手机号
     * @param {*} code 验证码
     */</span>
  <span class="token keyword">async</span> <span class="token function">sendSingleSms</span><span class="token punctuation">(</span><span class="token parameter">mobile<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> config <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.获取签名等配置</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> appid<span class="token punctuation">,</span> appkey<span class="token punctuation">,</span> templateId<span class="token punctuation">,</span> smsSign <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>qcloudsms<span class="token punctuation">;</span>
    <span class="token comment">// 2.实例化QcloudSms</span>
    <span class="token keyword">const</span> qcloudsms <span class="token operator">=</span> <span class="token function">QcloudSms</span><span class="token punctuation">(</span>appid<span class="token punctuation">,</span> appkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ssender <span class="token operator">=</span> qcloudsms<span class="token punctuation">.</span><span class="token function">SmsSingleSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.模板参数： {1}为您的登录验证码，请于{2}分钟内填写</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">[</span> code<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.发送</span>
    ssender<span class="token punctuation">.</span><span class="token function">sendWithParam</span><span class="token punctuation">(</span><span class="token string">'86'</span><span class="token punctuation">,</span> mobile<span class="token punctuation">,</span> templateId<span class="token punctuation">,</span> params<span class="token punctuation">,</span> smsSign<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 5.返回发送结果</span>
      <span class="token keyword">return</span> resData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> QcloudsmsService<span class="token punctuation">;</span>

</code></pre></div><p>使用方式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> config <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mobile <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>mobile<span class="token punctuation">;</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>qcloudsms<span class="token punctuation">.</span><span class="token function">sendSingleSms</span><span class="token punctuation">(</span>mobile<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_5-手机登录"><a href="#_5-手机登录" aria-hidden="true" class="header-anchor">#</a> 5.手机登录</h2> <p>**路由层：****/app/router.js</p> <p>路由增加phoneLogin</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// {app_root}/app/router.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 不需要验证token</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">:</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/phoneLogin'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>phoneLogin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/sendSms'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>sendSms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h4 id="创建操作数据库模型"><a href="#创建操作数据库模型" aria-hidden="true" class="header-anchor">#</a> 创建操作数据库模型</h4> <p>**model层：**创建model/user.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> <span class="token constant">UUIDV1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 主键自增</span>
    user_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token constant">UUIDV1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 设置uuid模式 433a4990-f6f3-11e9-a104-21c1dd7632ad</span>
    username<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    mobile<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    avatar_url<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 头像</span>
    status<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 值为1时启用，值为0时禁用</span>
    login_ip<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 最后登录ip</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    freezeTableName<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 关联user_info表</span>
  User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>UserInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span> foreignKey<span class="token punctuation">:</span> <span class="token string">'user_id'</span><span class="token punctuation">,</span> sourceKey<span class="token punctuation">:</span> <span class="token string">'user_id'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>**model层：**创建model/user_info.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">UUID</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>
  <span class="token keyword">const</span> sexArr <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'未知'</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">,</span> <span class="token string">'女'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> UserInfo <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user_info'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    user_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    nickname<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    sex<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
      allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      defaultValue<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sexArr<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">'sex'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> i <span class="token operator">=</span> sexArr<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> v <span class="token operator">===</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'sex'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 值为1时是男性，值为2时是女性，默认值为0时是未知</span>
    age<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 年龄</span>
    qg<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 情感</span>
    job<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 工作</span>
    birthday<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 生日</span>
    address<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 家乡</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    freezeTableName<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    tableName<span class="token punctuation">:</span> <span class="token string">'user_info'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// UserInfo.associate = function() {</span>
  <span class="token comment">//   app.model.UserInfo.belongsTo(app.model.User, { foreignKey: 'user_id', targetKey: 'user_id' });</span>
  <span class="token comment">// };</span>

  <span class="token keyword">return</span> UserInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>**controller层：**controller/v1/user.js</p> <p>user控制器增加<code>phoneLogin()</code></p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">/**
   * @summary 手机号登录
   * @description 通过手机号注册用户，如果没有注册，自动注册
   * @router post /api/v1/user/phoneLogin
   * @request body phoneLoginRequest *body 请求参数
   * @response 200 loginResponse 登录成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">phoneLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.验证参数</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>phoneLoginRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">phoneLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token punctuation">{</span> token <span class="token punctuation">}</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'登陆成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>**service层：**service/user.js</p> <p>增加：</p> <ul><li><code>phoneLogin()</code> 实现具体登录逻辑,</li> <li><code>isExist()</code> 校验用户是否存在，</li> <li><code>checkCode()</code> 验证码是否正确</li> <li><code>checkStatus()</code> 校验用户状态</li> <li><code>updateIp()</code> 更新ip</li> <li><code>createToken()</code> 创建token</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 手机号登陆</span>
  <span class="token keyword">async</span> <span class="token function">phoneLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> mobile<span class="token punctuation">,</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token comment">// 1.判断用户是否存在</span>
    <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isExist</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mobile <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.2 判断验证码是否正确</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkCode</span><span class="token punctuation">(</span>mobile<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.用户不存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2.1 自动生成密码</span>
      <span class="token comment">// const password = await ctx.helper.randomCode(8);</span>
      <span class="token keyword">const</span> password <span class="token operator">=</span> <span class="token string">'12345678'</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> passwordHash <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">genHash</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2.2 创建用户</span>
      user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        mobile<span class="token punctuation">,</span>
        username<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">u_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mobile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        password<span class="token punctuation">:</span> passwordHash<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2.3 创建用户资料表;</span>
      <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        user_id<span class="token punctuation">:</span> user<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.检测用户是否禁用</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkStatus</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.更新ip</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateIp</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.创建token</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
     * @description 校验用户是否存在
     * @param {*} obj 用户对象 {mobile:'12345678901'} | {'username':'w530385371'} | 邮箱
     */</span>
  <span class="token keyword">async</span> <span class="token function">isExist</span><span class="token punctuation">(</span><span class="token parameter">obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 登录的三种模式</span>
    <span class="token keyword">const</span> conditions <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'mobile'</span><span class="token punctuation">,</span> <span class="token string">'email'</span><span class="token punctuation">,</span> <span class="token string">'username'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 检测key是否在这三种模式中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>conditions<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 按条件查询</span>
      user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">:</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * 检测用户状态
   * @param {*} user user对象
   */</span>
  <span class="token keyword">async</span> <span class="token function">checkStatus</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'已禁止登录，请联系管理员'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token comment">/**
   * 检测验证码
   * @param {*} mobile 手机号
   * @param {*} code 验证码
   */</span>
  <span class="token keyword">async</span> <span class="token function">checkCode</span><span class="token punctuation">(</span><span class="token parameter">mobile<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token function">Number</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'验证码不正确'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 删除验证码</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/**
   * 更新ip
   * @param {*} user 
   */</span>
  <span class="token keyword">async</span> <span class="token function">updateIp</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> currentIp <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>ip<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentIp <span class="token operator">!==</span> user<span class="token punctuation">.</span>login_ip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> login_ip<span class="token punctuation">:</span> currentIp <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * 创建token 15天过期
   * @param {*} user user对象
   */</span>
  <span class="token keyword">async</span> <span class="token function">createToken</span><span class="token punctuation">(</span><span class="token parameter">user <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> config <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> app<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span> exp<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="jwt使用"><a href="#jwt使用" aria-hidden="true" class="header-anchor">#</a> jwt使用</h4> <p>这里使用<code>egg-jwt</code>插件</p> <p><strong>安装：</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i egg-jwt --save
</code></pre></div><p><strong>配置：</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>// <span class="token punctuation">{</span>app_root<span class="token punctuation">}</span>/config/plugin.js
exports.jwt <span class="token operator">=</span> <span class="token punctuation">{</span>
  enable: true,
  package: <span class="token string">&quot;egg-jwt&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// {app_root}/config/config.default.js</span>
config<span class="token punctuation">.</span>jwt <span class="token operator">=</span> <span class="token punctuation">{</span>
    secret<span class="token punctuation">:</span> <span class="token string">'secret'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>生成签名：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">/**
   * 创建token
   * @param {*} user user对象
   */</span>
  <span class="token keyword">async</span> <span class="token function">createToken</span><span class="token punctuation">(</span><span class="token parameter">user <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> config <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> app<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span> exp<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="jwt的问题"><a href="#jwt的问题" aria-hidden="true" class="header-anchor">#</a> jwt的问题</h4> <p>（1）JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。
（2）JWT 不加密的情况下，不能将秘密数据写入 JWT。
（3）JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。
（4）JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。
（5）JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。
（6）为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输 或者 代码层面也可以做安全检测，比如ip地址发生变化，MAC地址发生变化等等，可以要求重新登录</p> <h4 id="增加ip验证"><a href="#增加ip验证" aria-hidden="true" class="header-anchor">#</a> 增加ip验证</h4> <h2 id="_6-获取用户信息"><a href="#_6-获取用户信息" aria-hidden="true" class="header-anchor">#</a> 6.获取用户信息</h2> <p>**controller层：**controller/v1/user.js</p> <p>user控制器增加<code>current()</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
   * @summary 获取当前用户信息
   * @description 通过token获取当前用户信息
   * @router post /api/v1/user/current
   * @Request header string Authorization eg:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjo5fSwiaWF0IjoxNTcyMzI4MzEzfQ.8Jtjdm7ggPI_KdnzMn4wrd896E2vty8-ZquHk_l_q5E  请求头
   * @response 200 currnetUserResponse 登录成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'请求成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>**service层：**service/user.js</p> <p>创建 current()方法：</p> <p>1、通过ctx.state.user.data.id获取jwt签名中得id,然后进行数据库查询</p> <p>2、检测当前ip与登录ip是否相同</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取用户信息</span>
  <span class="token keyword">async</span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token comment">// user和user_info关联查询</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span>
      include<span class="token punctuation">:</span> <span class="token punctuation">{</span> model<span class="token punctuation">:</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>UserInfo <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">'用户不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 检测ip</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkIp</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 隐藏密码/ip</span>
    user<span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span>login_ip <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/**
   * 检测ip是否一致
   * @param {*} user user对象
   */</span>
  <span class="token keyword">async</span> <span class="token function">checkIp</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> currentIp <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>ip<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentIp <span class="token operator">!==</span> user<span class="token punctuation">.</span>login_ip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token string">'无权访问'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>如下图，访问登陆接口<code>/api/v1/user/phoneLogin</code>获取签名：</p> <p><img src="/blog/assets/img/egg06.7d5c3a81.png" alt="登陆获取签名"></p> <p>访问当前用户信息接口<code>/user/current</code>添加<code>header</code>头 <code>Authorization</code>，获取用户信息：</p> <p><img src="/blog/assets/img/egg07.b825a4b3.png" alt="登陆获取签名"></p> <p>当ip不一致，返回错误</p> <p><img src="/blog/assets/img/egg08.708902ba.png" alt="ip不一致"></p> <h2 id="_7-账号密码登录"><a href="#_7-账号密码登录" aria-hidden="true" class="header-anchor">#</a> 7.账号密码登录</h2> <p>**路由层：**app\router.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 不需要验证token</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">:</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/login'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>user<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>**contract层：**app\contract\user.js</p> <p>增加账号密码登陆请求参数校验</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 帐号密码登录请求</span>
  loginRequest<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    account<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'手机号|邮箱|用户名'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'13547556567|123123@qq.com|w13547556567'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'密码'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'wer55651231'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>**controller层：**app\controller\v1\user.js</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">/**
   * @summary 账户密码登录
   * @description 通过账户密码进行登录
   * @router post /api/v1/user/login
   * @request body loginRequest *body 请求参数
   * @response 200 loginResponse 登录成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>loginRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token punctuation">{</span> token <span class="token punctuation">}</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'登陆成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>**service层：**app\service\user.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 账户密码登陆</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> account<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token comment">// 1.校验账户，是用户名|邮箱|手机号</span>
    <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkAccountType</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.查询用户</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isExist</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'用户不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.校验密码</span>
    <span class="token keyword">const</span> compareResult <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>compareResult<span class="token punctuation">)</span> <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'密码错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.检测用户是否禁用</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkStatus</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.创建token</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/**
   * 检查账户类型
   * @param {*} account 账户名
   */</span>
  <span class="token keyword">async</span> <span class="token function">checkAccountType</span><span class="token punctuation">(</span>account <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> email<span class="token punctuation">:</span> account <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">isMobile</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> mobile<span class="token punctuation">:</span> account <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> username<span class="token punctuation">:</span> account <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="_8-第三方登录"><a href="#_8-第三方登录" aria-hidden="true" class="header-anchor">#</a> 8.第三方登录</h2> <p>暂定</p> <h1 id="三、话题分类开发"><a href="#三、话题分类开发" aria-hidden="true" class="header-anchor">#</a> 三、话题分类开发</h1> <h2 id="_1-数据表设计-2"><a href="#_1-数据表设计-2" aria-hidden="true" class="header-anchor">#</a> 1.数据表设计</h2> <table><thead><tr><th><strong>字段</strong></th> <th><strong>类型</strong></th> <th><strong>Null</strong></th> <th><strong>默认</strong></th> <th><strong>额外</strong></th> <th>描述</th></tr></thead> <tbody><tr><td>id</td> <td>int(11)</td> <td>否</td> <td></td> <td>auto_increment</td> <td></td></tr> <tr><td>class_id</td> <td>char(36)</td> <td>否</td> <td></td> <td></td> <td>uuid</td></tr> <tr><td>classname</td> <td>varchar(10)</td> <td>否</td> <td></td> <td></td> <td>分类名称</td></tr> <tr><td>status</td> <td>tinyint(1)</td> <td>否</td> <td></td> <td></td> <td>状态</td></tr> <tr><td>created_at</td> <td>datetime</td> <td>否</td> <td></td> <td></td> <td>创建时间</td></tr> <tr><td>updated_at</td> <td>datetime</td> <td>否</td> <td></td> <td></td> <td>更新时间</td></tr></tbody></table> <h2 id="_2-创建数据表-2"><a href="#_2-创建数据表-2" aria-hidden="true" class="header-anchor">#</a> 2.创建数据表</h2> <p>执行sequelize命令创建topic_class</p> <div class="language-bash extra-class"><pre class="language-bash"><code>npx sequelize migration:generate --name<span class="token operator">=</span>init-topic_class

</code></pre></div><p>生成以下文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 20191028094909-init-topic_class.js</span>
</code></pre></div><p>初始化表：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> <span class="token constant">UUIDV1</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Sequelize<span class="token punctuation">;</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'topic_class'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 主键</span>
      class_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token constant">UUIDV1</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// uuid</span>
      classname<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 分类名</span>
      status<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 值为1时启用，值为0时禁用</span>
      created_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
      updated_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      engine<span class="token punctuation">:</span> <span class="token string">'InnoDB'</span><span class="token punctuation">,</span>
      comment<span class="token punctuation">:</span> <span class="token string">'话题分类表'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      queryInterface<span class="token punctuation">.</span><span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token string">'topic_class'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token string">'class_id'</span><span class="token punctuation">,</span> <span class="token string">'classname'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token parameter">queryInterface</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'topic_class'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>执行 migrate 进行数据库变更，增加topic_class</p> <div class="language-bash extra-class"><pre class="language-bash"><code>npx sequelize db:migrate
</code></pre></div><h2 id="_3-创建模型"><a href="#_3-创建模型" aria-hidden="true" class="header-anchor">#</a> 3.创建模型</h2> <p>编写<code>topic_class</code>模型</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/model/topic_class.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> <span class="token constant">UUIDV1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> TopicClass <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'topic_class'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    class_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token constant">UUIDV1</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    classname<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    status<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 值为1时启用，值为0时禁用</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    freezeTableName<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    tableName<span class="token punctuation">:</span> <span class="token string">'topic_class'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> TopicClass<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="_4-创建restful-风格的url"><a href="#_4-创建restful-风格的url" aria-hidden="true" class="header-anchor">#</a> 4.创建RESTful 风格的url</h2> <p>这里我们通过 RESTful 的方式来定义路由， egg提供了 <code>app.resources('routerName', 'pathMatch', controller)</code> 快速在一个路径上生成 <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete" target="_blank" rel="noopener noreferrer">CRUD<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 路由结构。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 不需要验证token</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">:</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   	<span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// router.get('/topicclass/:id', controller.v1.topicClass.show);</span>
    <span class="token comment">// router.get('/topicclass', controller.v1.topicClass.index);</span>
    <span class="token comment">// router.post('/topicclass', controller.v1.topicClass.create);</span>
    <span class="token comment">// router.put('/topicclass', controller.v1.topicClass.update);</span>
    <span class="token comment">// router.delete('/topicclass/:id', controller.v1.topicClass.destroy);</span>
    router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'/topicclass'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>topicClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span><span class="token operator">...</span>  
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>上面代码就在 <code>/topicclass</code> 路径上部署了一组 CRUD 路径结构，对应的 Controller 为 <code>app/controller/v1/topic_class.js</code> ，接下来， 我们需要定义swa-ui文档规则以及在<code>topic_class.js</code> 里面实现对应的函数。</p> <h2 id="_5-定义文档规则"><a href="#_5-定义文档规则" aria-hidden="true" class="header-anchor">#</a> 5.定义文档规则</h2> <p>新增<code>app\contract\request\topic_class.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  classListRequest<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    page<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'当前分页数'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    limit<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'显示条数'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  classCreateRequest<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    classname<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'话题名称'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'分类01'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  classUpdateRequest<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    classname<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'话题名称'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'分类01'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    status<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'状态'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>新增<code>app\contract\response\topic_class.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取列表</span>
  getClassListResponse<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'array'</span><span class="token punctuation">,</span> itemType<span class="token punctuation">:</span> <span class="token string">'class'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    msg<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  getClassResponse<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'class'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    msg<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><code>app\contract\dto.js</code>新增自定义类型<code>Class</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token operator">...</span>
 <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'id 唯一键'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    class_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'uuid'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'67e9ee20-fec4-11e9-9152-116d6cc78126'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    classname<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'账户名'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'分类01'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    status<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'状态'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    createdAt<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'2019-11-04 13:31:52'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    updatedAt<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'2019-11-04 13:31:52'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="_6-控制器"><a href="#_6-控制器" aria-hidden="true" class="header-anchor">#</a> 6.控制器</h2> <p>创建controller/topic_class.js,实现路由对应的函数,以及对应的文档规则</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token comment">/**
 * @Controller 话题分类管理
 */</span>
<span class="token keyword">class</span> <span class="token class-name">TopicClassController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @summary 获取话题分类列表
   * @description 获取话题分类列表
   * @router get /api/v1/topicclass
   * @request body topicClassListRequest *body 请求参数
   * @response 200 getTopicClassResponse 请求成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>topicClassListRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>topicClass<span class="token punctuation">.</span><span class="token function">getTopicClassList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">:</span> result<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'请求成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * @summary 查询当前话题分类
   * @description 根据id查询话题分类
   * @router get /api/v1/topicclass/:id
   * @request path string id eg:1 请求参数
   * @response 200 baseResponse 请求成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> topicClass <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>topicClass<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">:</span> topicClass<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'请求成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * @summary 创建话题分类
   * @description 创建话题分类
   * @router post /api/v1/topicclass
   * @request body topicClassCreateRequest *body 请求参数
   * @response 201 baseResponse 创建成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>topicClassCreateRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>topicClass<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">:</span> result<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'创建成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * @summary 更新话题分类
   * @description 获取话题分类列表
   * @router put /api/v1/topicclass
   * @request body topicClassUpdateRequest *body 请求参数
   * @response 200 baseResponse 更新成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>topicClassUpdateRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>topicClass<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'更新成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * @summary 删除话题分类
   * @description 删除话题分类
   * @router delete /api/v1/topicclass/:id
   * @request path string id eg:1 请求参数
   * @response 200 baseResponse 删除成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>topicClass<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'删除成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> TopicClassController<span class="token punctuation">;</span>

</code></pre></div><h2 id="_7-service"><a href="#_7-service" aria-hidden="true" class="header-anchor">#</a> 7.service</h2> <p>创建service/topic_class.js,实现数据增删改查。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TopicClassService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">getTopicClassList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> page<span class="token punctuation">,</span> limit <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> currentPage <span class="token operator">=</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> currentLimit <span class="token operator">=</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TopicClass<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      limit<span class="token punctuation">:</span> currentLimit<span class="token punctuation">,</span> <span class="token comment">// 每页多少条</span>
      offset<span class="token punctuation">:</span> <span class="token punctuation">(</span>currentPage <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> currentLimit<span class="token punctuation">,</span> <span class="token comment">// 跳过多少条</span>
      order<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TopicClass<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 创建</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TopicClass<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> topicClass <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">await</span> topicClass<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 删除</span>
  <span class="token keyword">async</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> topicClass <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isExist</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> topicClass<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 检测分类是否存在</span>
  <span class="token keyword">async</span> <span class="token function">isExist</span><span class="token punctuation">(</span><span class="token parameter">_id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> _id <span class="token operator">||</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> topicClass <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TopicClass<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>topicClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">'当前分类不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> topicClass<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> TopicClassService<span class="token punctuation">;</span>


</code></pre></div><p><img src="/blog/assets/img/egg09.54dff8d6.png" alt="话题分类文档"></p> <h1 id="四、文章分类开发-同话题分类"><a href="#四、文章分类开发-同话题分类" aria-hidden="true" class="header-anchor">#</a> 四、文章分类开发(同话题分类)</h1> <h2 id="_1-数据表设计-3"><a href="#_1-数据表设计-3" aria-hidden="true" class="header-anchor">#</a> 1.数据表设计</h2> <table><thead><tr><th><strong>字段</strong></th> <th><strong>类型</strong></th> <th><strong>Null</strong></th> <th><strong>默认</strong></th> <th><strong>额外</strong></th> <th>描述</th></tr></thead> <tbody><tr><td>id</td> <td>int(11)</td> <td>否</td> <td></td> <td>auto_increment</td> <td></td></tr> <tr><td>class_id</td> <td>char(36)</td> <td>否</td> <td></td> <td></td> <td>uuid</td></tr> <tr><td>classname</td> <td>varchar(10)</td> <td>否</td> <td></td> <td></td> <td>分类名称</td></tr> <tr><td>status</td> <td>tinyint(1)</td> <td>否</td> <td></td> <td></td> <td>状态</td></tr> <tr><td>created_at</td> <td>datetime</td> <td>否</td> <td></td> <td></td> <td>创建时间</td></tr> <tr><td>updated_at</td> <td>datetime</td> <td>否</td> <td></td> <td></td> <td>更新时间</td></tr></tbody></table> <h2 id="_2-创建数据表-3"><a href="#_2-创建数据表-3" aria-hidden="true" class="header-anchor">#</a> 2.创建数据表</h2> <p>执行sequelize命令创建topic_class</p> <div class="language-bash extra-class"><pre class="language-bash"><code>npx sequelize migration:generate --name<span class="token operator">=</span>init-post_class

</code></pre></div><p>生成以下文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 20191028094909-init-post_class.js</span>
</code></pre></div><p>初始化表：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> <span class="token constant">UUIDV1</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Sequelize<span class="token punctuation">;</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'post_class'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 主键</span>
      class_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token constant">UUIDV1</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// uuid</span>
      classname<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 分类名</span>
      status<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 值为1时启用，值为0时禁用</span>
      created_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
      updated_at<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      engine<span class="token punctuation">:</span> <span class="token string">'InnoDB'</span><span class="token punctuation">,</span>
      comment<span class="token punctuation">:</span> <span class="token string">'文章分类表'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      queryInterface<span class="token punctuation">.</span><span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token string">'post_class'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token string">'class_id'</span><span class="token punctuation">,</span> <span class="token string">'classname'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token parameter">queryInterface</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'post_class'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>执行 migrate 进行数据库变更，增加post_class</p> <div class="language-bash extra-class"><pre class="language-bash"><code>npx sequelize db:migrate
</code></pre></div><h2 id="_3-创建模型-2"><a href="#_3-创建模型-2" aria-hidden="true" class="header-anchor">#</a> 3.创建模型</h2> <p>编写<code>post_class</code>模型</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/model/topic_class.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> <span class="token constant">UUIDV1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> PostClass <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'post_class'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    class_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token constant">UUIDV1</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    classname<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    status<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 值为1时启用，值为0时禁用</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    freezeTableName<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    tableName<span class="token punctuation">:</span> <span class="token string">'topic_class'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> PostClass<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="_4-创建restful-风格的url-2"><a href="#_4-创建restful-风格的url-2" aria-hidden="true" class="header-anchor">#</a> 4.创建RESTful 风格的url</h2> <p>这里我们通过 RESTful 的方式来定义路由， egg提供了 <code>app.resources('routerName', 'pathMatch', controller)</code> 快速在一个路径上生成 <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete" target="_blank" rel="noopener noreferrer">CRUD<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 路由结构。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 不需要验证token</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">:</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   	<span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// router.get('/postclass/:id', controller.v1.postclass.show);</span>
    <span class="token comment">// router.get('/postclass', controller.v1.postclass.index);</span>
    <span class="token comment">// router.post('/postclass', controller.v1.postclass.create);</span>
    <span class="token comment">// router.put('/postclass/:id', controller.v1.postclass.update);</span>
    <span class="token comment">// router.delete('/postclass/:id', controller.v1.postclass.destroy);</span>
    router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'/postclass'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>postClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span><span class="token operator">...</span>  
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>上面代码就在 <code>/topicclass</code> 路径上部署了一组 CRUD 路径结构，对应的 Controller 为 <code>app/controller/v1/post_class.js</code> ，接下来， 我们需要定义swa-ui文档规则以及在 <code>post_class.js</code> 里面实现对应的函数。</p> <h2 id="_5-定义文档规则-2"><a href="#_5-定义文档规则-2" aria-hidden="true" class="header-anchor">#</a> 5.定义文档规则</h2> <p>文章分类和话题分类用同一文档规则</p> <h2 id="_6-控制器-2"><a href="#_6-控制器-2" aria-hidden="true" class="header-anchor">#</a> 6.控制器</h2> <p>创建controller/post_class.js,实现路由对应的函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token comment">/**
 * @Controller 文章分类管理
 */</span>
<span class="token keyword">class</span> <span class="token class-name">PostClassController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @summary 获取分类列表
   * @description 获取分类列表
   * @router get /api/v1/postclass
   * @request query integer page 页码 默认 1
   * @request query integer limit 单页数量 默认 10
   * @response 200 getClassListResponse 请求成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>classListRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>postClass<span class="token punctuation">.</span><span class="token function">getClassList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">:</span> result<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'请求成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * @summary 查询当前话题分类
   * @description 根据id查询话题分类
   * @router get /api/v1/postclass/{id}
   * @request path string *id eg:1 请求参数
   * @response 200 getClassResponse 请求成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>postClass<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">:</span> result<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'请求成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * @summary 创建话题分类
   * @description 创建话题分类
   * @router post /api/v1/postclass
   * @request body classCreateRequest *body 请求参数
   * @response 201 baseResponse 创建成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>classCreateRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>postClass<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">:</span> result<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'创建成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * @summary 更新分类
   * @description 获取分类列表
   * @router put /api/v1/postclass/{id}
   * @request path string *id eg:1
   * @request body classUpdateRequest *body 请求参数
   * @response 200 baseResponse 更新成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>classUpdateRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>postClass<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'更新成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * @summary 删除分类
   * @description 删除分类
   * @router delete /api/v1/postclass/{id}
   * @request path string *id eg:1 请求参数
   * @response 200 baseResponse 删除成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>postClass<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token string">'删除成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> PostClassController<span class="token punctuation">;</span>

</code></pre></div><h2 id="_7-service-2"><a href="#_7-service-2" aria-hidden="true" class="header-anchor">#</a> 7.service</h2> <p>创建service/topic_class.js,实现数据增删改查。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">PostClassService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">getClassList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> page<span class="token punctuation">,</span> limit <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">const</span> currentPage <span class="token operator">=</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> currentLimit <span class="token operator">=</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>PostClass<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      limit<span class="token punctuation">:</span> currentLimit<span class="token punctuation">,</span> <span class="token comment">// 每页多少条</span>
      offset<span class="token punctuation">:</span> <span class="token punctuation">(</span>currentPage <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> currentLimit<span class="token punctuation">,</span> <span class="token comment">// 跳过多少条</span>
      order<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>PostClass<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 创建</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>PostClass<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> postClass <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">await</span> postClass<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 删除</span>
  <span class="token keyword">async</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> postClass <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> postClass<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 检测分类是否存在</span>
  <span class="token keyword">async</span> <span class="token function">isExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> postClass <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>PostClass<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>postClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">'当前分类不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> postClass<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> PostClassService<span class="token punctuation">;</span>

</code></pre></div><h1 id="五-文件上传模块"><a href="#五-文件上传模块" aria-hidden="true" class="header-anchor">#</a> 五.文件上传模块</h1> <p>form 表单中必须加 enctype=&quot;multipart/form-data&quot;。 表单默认提交数据的方式是
application/x-www-form-urlencoded 不是不能上传文件， 是只能上传文本格式的文件，
multipart/form-data 是将文件以二进制的形式上传， 这样可以实现多种类型的文件上传。</p> <p>在 Controller 中，单文件上传我们可以通过 <code>ctx.getFileStream()</code> 接口能获取到上传的文件流。 多文件上传需要通过获取所有文件流<code>ctx.multipart({ autoFields: true })</code>，遍历写入文件。</p> <p><strong>验证规则：</strong></p> <p>请求参数校验</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app\contract\request\upload.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>export <span class="token operator">=</span> <span class="token punctuation">{</span>
  singleRequest<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    file<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'formData'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'文件formData'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>响应</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app\contract\response\upload.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  singleResponse<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'uploadItem'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    msg<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  multiResponse<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'array'</span><span class="token punctuation">,</span> itemType<span class="token punctuation">:</span> <span class="token string">'uploadItem'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    msg<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>自定义类型</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app\contract\dto.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  uploadItem<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    file<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'上传路径'</span><span class="token punctuation">,</span> example<span class="token punctuation">:</span> <span class="token string">'/public/upload/2019-11-7/1573111099833.png'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>**路由：**app\router.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app\router.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 需要验证token</span>
  router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">:</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span> app<span class="token punctuation">.</span>jwt <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">router</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token operator">...</span><span class="token operator">...</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload/single'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>single<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload/multi'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>multi<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>**控制器：**app\controller\v1\upload.js</p> <p>先安装<code>mz-modules</code>处理文件流</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i mz-modules
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">const</span> pump <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mz-modules/pump'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mkdirp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mz-modules/mkdirp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * @Controller 文件上传
 */</span>
<span class="token keyword">class</span> <span class="token class-name">UploadController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @summary 单文件上传
   * @description 单文件上传
   * @router post /api/v1/upload/single
   * @Request header string Authorization eg:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjo5fSwiaWF0IjoxNTcyMzI4MzEzfQ.8Jtjdm7ggPI_KdnzMn4wrd896E2vty8-ZquHk_l_q5E  请求头
   * @request formData singleRequest *file 上传的文件
   * @response 200 singleResponse 请求成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">single</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token comment">// 1.读取文件流</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">getFileStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.设置上传的目录</span>
    <span class="token keyword">const</span> dir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>baseDir<span class="token punctuation">,</span> <span class="token string">'app/public/upload/'</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.创建目录</span>
    <span class="token keyword">await</span> <span class="token function">mkdirp</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.设置上传的文件名</span>
    <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.最终目标文件</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 6.写入文件</span>
    <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">pump</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> writeStream<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 或者 stream.pipe(writeStream);</span>
    <span class="token comment">// 6.返回上传的数据</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      file<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/public/upload/'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//   fields: stream.fields, // 所有表单字段都能通过 `stream.fields` 获取到</span>
    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * @summary 多文件上传
   * @description 多文件上传
   * @router post /api/v1/upload/multi
   * @request header string Authorization eg:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjo5fSwiaWF0IjoxNTcyMzI4MzEzfQ.8Jtjdm7ggPI_KdnzMn4wrd896E2vty8-ZquHk_l_q5E  请求头
   * @request formData singleRequest *file 上传的文件
   * @response 200 multiResponse 请求成功
   */</span>
  <span class="token keyword">async</span> <span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.获取所有文件流</span>
    <span class="token keyword">const</span> parts <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">multipart</span><span class="token punctuation">(</span><span class="token punctuation">{</span> autoFields<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// { autoFields: true }可以将除了文件的其它字段提取到 parts 的 filed 中</span>
    <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> stream<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>stream <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stream<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 2.设置上传的目录</span>
      <span class="token keyword">const</span> dir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>baseDir<span class="token punctuation">,</span> <span class="token string">'app/public/upload/'</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 3.创建目录</span>
      <span class="token keyword">await</span> <span class="token function">mkdirp</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 4.设置上传的文件名</span>
      <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 5.获取input name值</span>
      <span class="token keyword">const</span> fieldname <span class="token operator">=</span> stream<span class="token punctuation">.</span>fieldname<span class="token punctuation">;</span>
      <span class="token comment">// 6.最终目标文件</span>
      <span class="token keyword">const</span> target <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">pump</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> writeStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
      files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token punctuation">[</span>fieldname<span class="token punctuation">]</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/public/upload/'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> res<span class="token punctuation">:</span> files <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ctx.helper.success({ ctx, res: {</span>
    <span class="token comment">//   files,</span>
    <span class="token comment">//   fields: parts.field, // 所有表单字段都能通过 `parts.fields` 获取到</span>
    <span class="token comment">// } });</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UploadController<span class="token punctuation">;</span>

</code></pre></div><p><strong>配置项：</strong> config\config.default.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 上传文件配置</span>
  config<span class="token punctuation">.</span>multipart <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 只允许上传 以下 格式</span>
    whitelist<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'.jpg'</span><span class="token punctuation">,</span> <span class="token string">'.jpeg'</span><span class="token punctuation">,</span> <span class="token string">'.png'</span><span class="token punctuation">,</span> <span class="token string">'.gif'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">10/30/2020, 5:21:02 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.ee223f02.js" defer></script><script src="/blog/assets/js/2.f364336e.js" defer></script><script src="/blog/assets/js/5.2cc523f9.js" defer></script>
  </body>
</html>
